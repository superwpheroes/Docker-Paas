var usinApp=angular.module("usinApp",["ngRoute","ngSanitize","usinNgHelpers","dndLists","ngMaterial","ngAnimate","usinPartials"],usinHelpers.config.httpProvider).config(usinHelpers.config.animateProvider).config(usinHelpers.config.mdThemingProvider).config(usinHelpers.config.mdDateLocaleProvider).config(["$routeProvider","$locationProvider",function(a,b){var c=window.USIN.viewsURL;b.html5Mode(!1),a.when("/",{controller:"UsinMainCtrl",templateUrl:c+"/main.html"}).when("/user/:userId",{controller:"UsinProfileCtrl",templateUrl:c+"/profile.html"}).otherwise({redirectTo:"/"})}]).value("options",{}).run(["options",function(a){var b=window.USIN,c=["usersPerPage","orderBy","order"];for(var d in b)b.hasOwnProperty(d)&&-1===c.indexOf(d)&&(a[d]=b[d]);a.userQuery={usersPerPage:b.usersPerPage,orderBy:b.orderBy,order:b.order}}]);angular.module("usinApp").filter("displayedFields",function(){return function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.show&&!e.hideOnTable&&b.push(e)}return b}}).filter("tableFields",function(){return function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.hideOnTable||b.push(e)}return b}}).filter("displayedFieldsIds",function(){return function(a){var b=[];return angular.forEach(a,function(a,c){a.show&&b.push(a.id)}),b}}).filter("fieldIds",function(){return function(a){var b=[];return angular.forEach(a,function(a,c){b.push(a.id)}),b}}).filter("pluckByKey",function(){return function(a,b){var c=[];return angular.forEach(a,function(a,d){c.push(a[b])}),c}}).filter("optionKeyToVal",function(){return function(a,b){for(var c in b)if(b[c].key==a)return b[c].val;return a}}).filter("fieldsByType",function(){return function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)a[d].fieldType&&a[d].fieldType===b&&c.push(a[d]);return c}}).filter("groupTagHtml",["$sce","options",function(a,b){var c={};return function(d){if(c[d])return c[d];var e=b.groups.filter(function(a){return a.key==d});if(e&&e.length){var f=e[0],g=a.trustAsHtml('<span class="usin-group-tag" style="background-color:#'+f.color+';">'+f.val+"</span>");return c[d]=g,g}return""}}]).filter("pendingFilters",function(){return function(a){return a.filter(function(a){return a.editing})}}),usinApp.controller("UsinBulkActionsCtrl",["$scope","options","UsinBulkActionsState","$mdDialog","$controller",function(a,b,c,d,e){a.bulkActions=c,a.strings=b.strings,a.optionsVisible=!1,a.toggleOptions=function(){a.optionsVisible=!a.optionsVisible},a.showGroupEditDialog=function(c){a.bulkActions.setAction(c),d.show({controller:"UsinGroupEditCtrl",templateUrl:b.viewsURL+"/group-edit-dialog.html",parent:angular.element(document.body),clickOutsideToClose:!0}),a.optionsVisible=!1}}]),usinApp.controller("UsinConfirmDialogCtrl",["$scope","$mdDialog","options","UsinError",function(a,b,c,d){a.isLoading=!1,a.error="",a.strings=c.strings,a.close=function(){b.cancel()},a.callAction=function(){a.action&&!a.isLoading&&(a.isLoading=!0,a.action.call().then(function(b){a.close(),a.onSuccess&&a.onSuccess.call(this,b.data)},function(b){a.error=d.buildFromResponse(b).msg})["finally"](function(){a.isLoading=!1}))}}]),usinApp.controller("UsinCreateSegmentCtrl",["$scope","$mdDialog","UsinSegments",function(a,b,c){a.segmentName="",a.segmentError="",a.closeDialog=function(){b.cancel()},a.saveSegment=function(){a.isLoading||(a.isLoading=!0,c.saveSegment(a.segmentName,a.filters).then(function(b){a.closeDialog(),a.updateSegments(b.data)},function(b){a.segmentError=b.data&&b.data.error||a.strings.createSegmentError})["finally"](function(){a.isLoading=!1}))},a.doOnEnter=function(b){b.preventDefault(),a.segmentName&&a.saveSegment()}}]),usinApp.controller("UsinGroupEditCtrl",["$scope","$rootScope","options","UsinUserQuery","UsinBulkActionsState","$mdDialog",function(a,b,c,d,e,f){a.bulkActions=e,a.strings=c.strings,a.action=a.bulkActions.getAction(),a.isAddAction="add"===a.action,a.groups=c.groups,a.isLoading=!1,a.title=a.strings[a.action+"Group"];var g=1===a.bulkActions.getCount()?"UserGroupInfo":"UsersGroupInfo";a.info=a.strings[a.action+g].replace("%d",a.bulkActions.getCount()),a.cancel=function(){f.cancel()},a.apply=function(){a.isLoading=!0,d.updateGroupsBulk(a.bulkActions.getChecked(),a.selectedGroup,a.action).then(function(c){a.cancel(),b.$broadcast("groupUpdated")},function(b){a.error=b.data&&b.data.error||a.strings.groupUpdateError})["finally"](function(){a.isLoading=!1})}}]),usinApp.controller("UsinListOptionsCtrl",["$scope","$filter","options","UsinListOptionsQuery","UsinListState","UsinBulkActionsState","$usinConfirmDialog",function(a,b,c,d,e,f,g){function h(){i=b("displayedFieldsIds")(a.fields).length}a.displayed=!1,a.showMap=c.geolocationActive,a.canExportUsers=c.canExportUsers,a.canUpdateUsers=c.canUpdateUsers,a.canManageSegments=c.canManageSegments,a.bulkActions=f;var i;h(),a.toggleDisplayed=function(){a.displayed=!a.displayed},a.onCheckboxChange=function(c){c.show=!c.show;var e=b("displayedFieldsIds")(a.fields),f=e.length>i;f?(a.loading.start(),d.updateDisplayedFields(e).then(function(b){a.refreshDisplayedFields()})):(d.updateDisplayedFields(e),a.setDisplayedFields()),h()},a.onToggleView=function(){a.toggleView()},a.reorder=function(c){a.fields.splice(c,1),a.setDisplayedFields();var e=b("fieldIds")(a.fields);d.updateFieldOrder(e)},a.showConfirm=function(c){g.show(angular.extend(a.$new(!0),{title:a.strings.exportAction,content:"<p>"+a.strings.confirmExport.replace("%s",a.total.current)+"</p>",actionText:a.strings.exportAction,action:function(){return d.getExportLink(b("displayedFieldsIds")(a.fields),a.filters,e.get("order"))},onSuccess:function(a){location.href=a.export_url}}))}}]),usinApp.controller("UsinListCtrl",["$scope","UsinUserQuery","options","$filter","UsinSession","$location","UsinListState","$rootScope","UsinBulkActionsState","UsinFields",function(a,b,c,d,e,f,g,h,i,j){a.userList={page:g.get("page")||1,users:[],usersPerPage:c.userQuery.usersPerPage,orderBy:e.get("usinorderby")||c.userQuery.orderBy,order:e.get("usinorder")||c.userQuery.order},g.set("order",{orderBy:a.userList.orderBy,order:a.userList.order}),a.total=null,a.currentTotal=0;var k=function(){a.loading.start();var c=g.get("refreshCacheRequired")||!1;b.getUsers(a.userList.page,a.userList.usersPerPage,a.userList.orderBy,a.userList.order,a.filters,c).then(function(b){var c=b.data;a.loading.stop(),a.removeErrors(),l(c.users,parseInt(c.alltotal,10),parseInt(c.total,10))},function(b){l([],0,0),a.loading.stop(),a.setError(b)}),g.set("refreshCacheRequired",!1)};k();var l=function(b,c,e){a.total=c,a.currentTotal=e,a.userList.users=b,i.setAll(d("pluckByKey")(b,"ID")),a.$broadcast("usinUsersChanged"),a.$emit("usinUsersChanged"),a.setTotal({all:a.total,current:a.currentTotal})};a.setOrderBy=function(b){if(!a.loading.isLoading()){if(a.userList.orderBy===b)a.userList.order="DESC"===a.userList.order?"ASC":"DESC";else{var c=j.getField(b);if(c.order===!1)return;a.userList.orderBy=b,a.userList.order=c.order}e.set("usinorderby",a.userList.orderBy),e.set("usinorder",a.userList.order),g.set("order",{orderBy:a.userList.orderBy,order:a.userList.order}),a.userList.page=1,i.uncheckAll(),k()}},a.setUsersPerPage=function(){a.userList.page=1,i.uncheckAll(),k()},a.$on("usinFilterApplied",function(){a.userList.page=1,i.uncheckAll(),k()}),a.$on("pageChange",function(b,c){a.userList.page=c,g.set("page",c),i.uncheckAll(),k()}),a.$on("fieldsChange",function(a,b){g.set("refreshCacheRequired",!0),k()}),a.$on("groupUpdated",function(){g.set("refreshCacheRequired",!0),k()}),h.$on("usinUserUpdated",function(a){g.set("refreshCacheRequired",!0)})}]),usinApp.controller("UsinMainCtrl",["$scope","options","$filter","UsinSession","UsinLoading","UsinError","UsinFilterFactory",function(a,b,c,d,e,f,g){function h(){var a=d.get("usinfilters")||[];return a.map(function(a){return g.create(a,null)})}function i(a){filterData=a.map(function(a){return a.toHash()}),d.set("usinfilters",filterData)}a.loading=!1,a.strings=b.strings,a.listView=!0,a.error={},a.filters=h(),a.fields=c("tableFields")(b.fields),a.filterFields=b.fields,a.groups=b.groups;var j=!1;a.setClearTotal=function(){a.total={all:0,current:0,map:null}},a.setClearTotal(),a.setDisplayedFields=function(){a.showFields=c("displayedFields")(a.fields)},a.refreshDisplayedFields=function(){j=!0,a.$broadcast("fieldsChange")},a.$on("usinUsersChanged",function(){j&&(j=!1,a.setDisplayedFields())}),a.setDisplayedFields(),a.applyFilters=function(){a.$broadcast("usinFilterApplied"),i(a.filters)},a.toggleView=function(){a.setClearTotal(),a.listView=!a.listView},a.setTotal=function(b){angular.extend(a.total,b)},a.setError=function(b){a.error=f.buildFromResponse(b)},a.removeErrors=function(){a.error={}},a.loading=e}]),usinApp.controller("UsinMapCtrl",["$scope","UsinUserQuery",function(a,b){var c=function(){a.loading.start(),b.getCoordinates(a.filters).then(function(b){var c=b.data;a.loading.stop();var d=[];if(c.length)for(var e in c)d.push({coordinates:c[e].coordinates,title:c[e].username});a.setTotal({map:c.length}),a.mapOptions={markers:d,zoom:2}},function(b){a.loading.stop(),a.setError(b)})};c(),a.$on("usinFilterApplied",function(){c()})}]),usinApp.controller("UsinPaginationCtrl",["$scope","options","UsinListOptionsQuery",function(a,b,c){a.pages=0,a.pageOptions=b.pageOptions.map(function(a){return{key:a,val:a}});var d=function(){a.userPage=a.userList.page,a.currentTotal?a.pages=Math.ceil(a.currentTotal/a.userList.usersPerPage):a.pages=0};d(),a.$on("usinUsersChanged",d),a.changePage=function(b){a.loading.isLoading()||("number"!=typeof b&&(b=parseInt(b,10)),b>=1&&b<=a.pages&&a.$emit("pageChange",b))},a.onUsersPerPageChange=function(){a.setUsersPerPage(),c.updateUsersPerPage(a.userList.usersPerPage)}}]),usinApp.controller("UsinProfileActivityDialogCtrl",["$scope","options","$mdDialog","activityType","userId","title","UsinError","UsinUserQuery",function(a,b,c,d,e,f,g,h){a.strings=b.strings,a.error=null,a.loading=!0,a.items=[],a.itemProps=[],a.title=f,a.closeDialog=function(){c.cancel()},h.getActivityList(e,d).then(function(b){a.loading=!1,a.items=b.data.items,a.itemProps=b.data.itemProps},function(b){a.loading=!1,a.error=g.buildFromResponse(b)})}]),usinApp.controller("UsinProfileEditableFieldCtrl",["$scope","$rootScope","options","UsinUserQuery",function(a,b,c,d){a.loading=!1,a.errorMsg="",a.editing=!1,a.toggleEdit=function(){a.editing=!a.editing},a.updateField=function(){a.loading||(a.loading=!0,a.errorMsg="",d.updateUserField(a.user.ID,a.field.id,a.user[a.field.id]).then(function(c){a.loading=!1,a.editing=!1,b.$broadcast("usinUserUpdated")},function(b){a.loading=!1,a.errorMsg=b.data&&b.data.error||c.strings.fieldUpdateError}))},a.clearSelection=function(){a.user[a.field.id]=null}}]),usinApp.controller("UsinProfileGroupsCtrl",["$scope","options","UsinUserQuery","$rootScope",function(a,b,c,d){var e,f;a.editing=!1,a.allGroups=b.groups,a.groupLoading=!1,a.toggleEdit=function(){a.editing=!a.editing},a.userHasGroup=function(b){return a.user?-1!==a.user.user_groups.indexOf(b):void 0},e=function(b){a.user.user_groups.push(b)},f=function(b){var c=a.user.user_groups.indexOf(b);c>-1&&a.user.user_groups.splice(c,1)},a.toggleGroup=function(b){a.userHasGroup(b)?f(b):e(b)},a.updateGroups=function(){a.groupLoading||(a.groupLoading=!0,c.updateGroups(a.user.ID,a.user.user_groups).then(function(b){a.groupLoading=!1,a.editing=!1,d.$broadcast("usinUserUpdated")},function(c){a.groupLoading=!1,a.groupErrorMsg=c.data&&c.data.error||b.strings.groupUpdateError}))}}]),usinApp.controller("UsinProfileNotesCtrl",["$scope","options","UsinUserQuery","$rootScope",function(a,b,c,d){a.noteContent="",a.noteLoading=!1,a.noteErrorMsg="",a.startNoteLoading=function(){a.noteLoading=!0},a.stopNoteLoading=function(){a.noteLoading=!1},a.doOnError=function(c){a.stopNoteLoading(),a.noteErrorMsg=c.data&&c.data.error||b.strings.noteError},a.updateNotes=function(b){a.user.notes=b},a.addNote=function(){!a.noteLoading&&a.noteContent&&(a.startNoteLoading(),c.addNote(a.user.ID,a.noteContent).then(function(b){var c=b.data;a.stopNoteLoading(),a.updateNotes(c.notes),d.$broadcast("usinUserUpdated"),a.noteContent=""},a.doOnError))},a.deleteNote=function(b,e){a.noteLoading||(a.startNoteLoading(),c.deleteNote(b).then(function(b){b.data;a.stopNoteLoading(),a.user.notes.splice(e,1),d.$broadcast("usinUserUpdated")},a.doOnError))}}]),usinApp.controller("UsinProfileCtrl",["$scope","$routeParams","UsinUserQuery","options","UsinError","$mdDialog","UsinProfileSettingsFactory","UsinError","$filter",function(a,b,c,d,e,f,g,e,h){function i(){return a.settings.factory.fields}function j(){return a.settings.factory.activity}function k(){var b=h("fieldsByType")(d.unorderedFields,"general");a.settings={factory:g.init(b,a.user.activity),loading:!1,editing:!1,error:""},a.personalFields=h("fieldsByType")(d.unorderedFields,"personal"),a.generalFields=i().getItems(),a.activityItems=j().getItems(),l()}function l(){a.hiddenFieldsCount=i().hiddenCount(),a.hiddenActivityCount=j().hiddenCount()}a.settings={},a.customTemplates=d.customTemplates,a.strings=d.strings,a.loading=!0,a.canUpdateUsers=d.canUpdateUsers,a.error={},c.getUser(b.userId).then(function(b){a.loading=!1,a.user=b.data,k(),d.geolocationActive&&a.user.coordinates&&a.user.coordinates.lng&&a.user.coordinates.lat&&(a.mapOptions={center:{lng:a.user.coordinates.lng,lat:a.user.coordinates.lat},centerMarker:!0,zoom:6,disableScrollZoom:!0})},function(b){a.loading=!1,a.error=e.buildFromResponse(b)}),a.loadAllActivity=function(b){f.show({locals:{activityType:b.type,userId:a.user.ID,title:b.label},controller:"UsinProfileActivityDialogCtrl",templateUrl:d.viewsURL+"/profile-activity-dialog.html",parent:angular.element(document.body),clickOutsideToClose:!0})},a.toggleEditSettings=function(){function b(){a.settings.loading=!0,a.settings.factory.save().then(function(){a.settings.editing=!1},function(b){a.settings.error=e.buildFromResponse(b).msg})["finally"](function(){a.settings.loading=!1})}function c(){a.settings.editing=!0}a.settings.editing?b():c()},a.getUserActivity=function(b){var c=a.user.activity.filter(function(a){return a.type&&a.type==b});return c.length?c[0]:null},a.toggleFieldVisibility=function(a){i().toggleVisibility(a.id),l()},a.reorderFields=function(a){i().removeItem(a)},a.addSeparator=function(a){i().addSeparator(a)},a.removeSeparator=function(a){i().removeSeparator(a)},a.toggleActivityVisibility=function(a){j().toggleVisibility(a.id),l()},a.reorderActivity=function(a){j().removeItem(a)}}]),usinApp.controller("UsinSegmentsCtrl",["$scope","$rootScope","options","$mdDialog","$usinConfirmDialog","UsinSegments","$filter","UsinFilterFactory",function(a,b,c,d,e,f,g,h){a.updateSegments=function(b){a.segments=b},a.optionsVisible=!1,a.updateSegments(c.segments),a.toggleOptions=function(){a.optionsVisible=!a.optionsVisible},a.canCreateSegment=function(){return a.filters.length&&!g("pendingFilters")(a.filters).length},a.openSegmentDialog=function(){d.show({scope:a,preserveScope:!0,controller:"UsinCreateSegmentCtrl",templateUrl:c.viewsURL+"/create-segment-dialog.html",parent:angular.element(document.body),clickOutsideToClose:!0}),a.optionsVisible=!1},a.deleteSegment=function(b){e.show(angular.extend(a.$new(!0),{title:a.strings.deleteSegment,content:"<p>"+a.strings.confirmDeleteSegment.replace("%s",b.name)+"</p>",actionText:a.strings.deleteSegment,action:function(){return f.deleteSegment(b.id)},onSuccess:function(b){a.updateSegments(b)}}))},a.applySegment=function(c){var d=c.filters.map(function(a){return h.create(a,null)});b.$broadcast("usinApplySegment",d),a.toggleOptions()}}]),usinApp.directive("usinAddSeparator",["options",function(a){return{restrict:"EA",replace:!1,templateUrl:a.viewsURL+"/add-separator.html",scope:{mapOptions:"=",onAddSeparator:"&"},link:function(b,c,d,e){function f(){b.title=""}b.strings=a.strings,f(),b.add=function(){b.onAddSeparator({title:b.title}),f()}}}}]),usinApp.directive("usinBulkActions",["options","$filter",function(a,b){return{restrict:"EAC",templateUrl:a.viewsURL+"/bulk-actions.html",replace:!0,controller:"UsinBulkActionsCtrl"}}]),usinApp.directive("usinDateFilter",["options","UsinDate","UsinFields",function(a,b,c){return{restrict:"EA",templateUrl:a.viewsURL+"/date-pick.html",replace:!0,scope:{condition:"=",operator:"=",by:"="},link:function(c,d,e){c.strings=a.strings,c.date=new Date,c.updateDate=function(){c.condition=b.dateObjectToString(c.date)},c.isDateOperator=function(a){return b.isDateOperator(a)},c.updateDate=function(){c.condition=b.dateObjectToString(c.date)},c.updateDaysAgo=function(){c.condition=c.daysAgo},c.setDefaultValue=function(){c.isDateOperator(c.operator)?c.updateDate():c.condition=null},c.applySetValue=function(){c.isDateOperator(c.operator)?c.date=b.dateStringToObject(c.condition):c.daysAgo=c.condition},c.condition?c.applySetValue():c.setDefaultValue(),c.$watch("by",function(a,b){a!=b&&(c.date=new Date)}),c.$watch("operator",function(a,b){var d=c.isDateOperator(b),e=c.isDateOperator(a);d^e&&c.setDefaultValue()}),c.$watch("condition",function(a,b){c.isDateOperator(c.operator)||a===c.daysAgo||c.applySetValue()})}}}]),usinApp.directive("usinFilterCombined",["options","$filter",function(a,b){return{restrict:"EA",templateUrl:a.viewsURL+"/filter-combined.html",replace:!0,scope:{items:"=",condition:"="},link:function(b,c,d){function e(){b.disabledItems=b.condition.map(function(a){return a.id})}function f(a){return null===a?!0:a instanceof Array?null===a[0]&&null===a[1]:!1}b.disabledItems=[],b.strings=a.strings,b.condition||(b.condition=[{id:null,val:null}]),e(),b.addItem=function(){b.condition.push({id:null,val:null})},b.doOnFieldSelected=function(a,c){var d=b.getItemProps(c),f=d.type;b.condition[a]=angular.copy(d),"number"==f||"date"==f?b.condition[a].val=[null,null]:b.condition[a].val=null,e()},b.getItemProps=function(a){for(var c in b.items)if(b.items[c].id==a)return b.items[c]},b.canAddMore=function(){if(null===b.condition)return!1;var a=b.condition[b.condition.length-1].val;return b.disabledItems.length<b.items.length&&!f(a)}}}}]),usinApp.directive("usinFilter",["options","UsinFilterFactory","UsinFields",function(a,b,c){return{restrict:"EA",templateUrl:a.viewsURL+"/filter.html",replace:!0,scope:{fields:"=",filters:"=",loading:"=",broadcastChange:"&"},link:function(d,e,f){d.strings=a.strings,d.filtersPending=function(){return d.filters.filter(function(a){return a.editing===!0}).length>0},d.addFilter=function(){if(!d.filtersPending()&&!d.loading.isLoading()){var a=b.createEmpty();a.editing=!0,d.filters.push(a)}},d.$on("usinApplySegment",function(a,b){d.filters.splice(0,d.filters.length),Array.prototype.push.apply(d.filters,b),d.broadcastChange()}),d.doOnFieldSelected=function(a,e){var f=c.getField(e.by),e=b.create({},f);e.editing=!0,e.setDefaultOperator(),d.filters[a]=e},d.applyFilter=function(a){var b=null===a.condition||""===a.condition;(!b||a.isNullOperator())&&(a.editing=!1,d.broadcastChange())},d.clearAll=function(){d.filters.splice(0,d.filters.length),d.broadcastChange()},d.remove=function(a){if(!d.loading.isLoading()){var b=d.filters.indexOf(a);d.filters.splice(b,1),d.broadcastChange()}},d.edit=function(a){d.filtersPending()||(a.editing=!0)}}}}]),usinApp.directive("usinListOptions",["options","UsinListOptionsQuery","$filter",function(a,b,c){return{restrict:"EAC",templateUrl:a.viewsURL+"/list-options.html",replace:!0,controller:"UsinListOptionsCtrl"}}]),usinApp.directive("usinListView",["options","$filter",function(a,b){return{restrict:"EAC",templateUrl:a.viewsURL+"/list.html",replace:!0,controller:"UsinListCtrl"}}]),usinApp.directive("usinMap",["UsinMapHelper",function(a){return{restrict:"EA",replace:!1,scope:{mapOptions:"="},link:function(b,c,d,e){function f(){if(!h){var c=a.createMap(j,b.mapOptions);h=c.map,c.mc&&(i=c.mc)}h._onResize(),jQuery(j).addClass("usin-map-loaded")}function g(){var c=b.mapOptions.markers;c&&(i=i?a.refreshMarkers(h,i,c):a.addMarkers(h,c))}var h,i,j=document.createElement("div");j.className="usin-map",j.id="usin-map",c.prepend(j),b.mapOptions&&f(),b.$watch("mapOptions",function(a){a&&!h?f():a&&h&&g()})}}}]),usinApp.directive("usinProfileEditableField",["options",function(a){return{restrict:"EAC",templateUrl:a.viewsURL+"/profile-editable-field.html",replace:!1,controller:"UsinProfileEditableFieldCtrl"}}]),usinApp.directive("usinProfileGroups",["options",function(a){return{restrict:"EAC",templateUrl:a.viewsURL+"/profile-groups.html",replace:!0,controller:"UsinProfileGroupsCtrl"}}]),usinApp.directive("usinProfileNotes",["options",function(a){return{restrict:"EAC",templateUrl:a.viewsURL+"/profile-notes.html",replace:!0,controller:"UsinProfileNotesCtrl"}}]),usinApp.directive("usinSegments",["options","$filter",function(a,b){return{restrict:"EAC",templateUrl:a.viewsURL+"/segments.html",replace:!0,controller:"UsinSegmentsCtrl"}}]),usinApp.factory("UsinBulkActionsState",function(){var a=[],b=[],c="",d=[],e=!0;return{isAllChecked:function(){return 0===this._getDiff().length},isAllIndeterminate:function(){var a=this._getDiff();return a.length!==b.length&&0!==a.length},isAnyChecked:function(){return a.length>0},_getDiff:function(){return e&&(d=b.filter(function(b){return a.indexOf(b)<0}),e=!1),d},toggleAll:function(){this.isAllChecked()?this.uncheckAll():this.checkAll(),e=!0},uncheckAll:function(){a=[],e=!0},checkAll:function(){a=b.slice(),e=!0},isChecked:function(b){return-1!==a.indexOf(b)},toggle:function(b){if(this.isChecked(b)){var c=a.indexOf(b);a.splice(c,1)}else a.push(b);e=!0},getChecked:function(){return a},getCount:function(){return a.length},setAction:function(a){c=a},getAction:function(){return c},resetAction:function(){c=""},setAll:function(c){b=c,a=a.filter(function(a){return b.indexOf(a)>=0}),e=!0}}}),usinApp.factory("$usinConfirmDialog",["options","$mdDialog",function(a,b){return{show:function(c){return b.show({scope:c,controller:"UsinConfirmDialogCtrl",templateUrl:a.viewsURL+"/confirm-dialog.html",parent:angular.element(document.body),clickOutsideToClose:!0})}}}]),usinApp.factory("UsinError",["options",function(a){return{buildFromResponse:function(b){var c={infoVisible:!1},d=b.data&&b.data.error||a.strings.errorLoading;return b.status&&(d+=" - Status code: "+b.status),c.msg=d,b.data.info&&(c.info=b.data.info),c}}}]),usinApp.factory("UsinFields",["options",function(a){return{getField:function(b){var c=null;return angular.forEach(a.fields,function(a,d){a.id===b&&(c=a)}),c},getFieldCombinedItem:function(a,b){var c=a.filter.items.filter(function(a){return a.id===b});return c.length?c[0]:void 0},getFilterOption:function(a,b){var c=this.getField(a);return c&&c.filter&&c.filter[b]?c.filter[b]:void 0}}}]),usinApp.factory("UsinFilterFactory",["options","$filter","UsinFields","UsinDate",function(a,b,c,d){function e(){}function f(){}function g(){this._optionKeys.push("conditionLabel")}function h(){}function i(){}var j=a.strings;return e.prototype=angular.extend(e.prototype,{_optionKeys:["condition","by","type","operator","label"],_nullOperators:["isnull","notnull","isset","notset"],init:function(a,b){var c=this;this.config=a,this.field=angular.copy(b),this.editing=!1,this._optionKeys.forEach(function(b){c[b]="undefined"==typeof a[b]?null:a[b]}),this.by=this.by||this.field.id,this.label=this.label||this.field.name,this.type=this.type||this.field.filter.type,this.setOperators()},getFieldConfig:function(a){return this.field.filter[a]||null},setOperators:function(){var b=a.filterOperators[this.type],c=[];this.field.filter.disallow_null&&(c=this._nullOperators),this.operators=b.filter(function(a){return-1===c.indexOf(a.key)})},setDefaultOperator:function(){this.operators&&this.operators.length&&(this.operator=this.operators[0].key)},isOptionType:function(){return!1},isDateType:function(){return!1},isNullOperator:function(){var a=-1!==this._nullOperators.indexOf(this.operator);return a},isTextField:function(){return-1!==a.textFieldTypes.indexOf(this.type)},toHash:function(){var a=this,b={};return a._optionKeys.forEach(function(c){b[c]=a[c]}),b},formatCondition:function(){return this.condition},previewCondition:function(){return this.isNullOperator()?"":this.formatCondition()},previewOperator:function(a){if(!this.operator)return"";for(var b in this.operators)if(this.operators[b].key===this.operator)return this.operators[b].val;return this.operator}}),f.prototype=angular.extend(new e,{formatCondition:function(){return d.isDateOperator(this.operator)?d.dateStringToPrettyString(this.condition):this.condition+" "+j.daysAgo},setOperators:function(){e.prototype.setOperators.call(this),this.field.filter.nodaysago&&(this.operators=this.operators.filter(function(a){return-1===["lessthan","morethan","exactly"].indexOf(a.key)}))},isDateType:function(){return!0}}),g.prototype=angular.extend(new e,{init:function(a,b){e.prototype.init.call(this,a,b),this.options=this.field.filter.options,this.searchAction=this.field.filter.searchAction||null},isOptionType:function(){return!0},formatCondition:function(){return this.getConditionLabel()},getConditionLabel:function(){var a=this.options.filter(function(a){return a.key==this.condition}.bind(this));return a.length?a[0].val:this.conditionLabel?this.conditionLabel:this.condition},toHash:function(){var a=e.prototype.toHash.call(this);return a.conditionLabel=this.getConditionLabel(),a}}),h.prototype=angular.extend(new e,{init:function(a,b){var d=this;e.prototype.init.call(this,a,b),this.condition instanceof Array&&this.condition.forEach(function(a){"select"==a.type&&(a.options=c.getFieldCombinedItem(d.field,a.id).options)})},setOperators:function(){},toHash:function(){var a=e.prototype.toHash.call(this);return a.condition instanceof Array&&(a.condition=angular.copy(a.condition),a.condition.forEach(function(a){"select"==a.type&&(a.conditionLabel=this.getSelectConditionLabel(a),delete a.options)}.bind(this))),a},getSelectConditionLabel:function(a){var b=a.options.filter(function(b){return b.key==a.val}.bind(this));return b.length?b[0].val:a.conditionLabel?a.conditionLabel:a.val},formatCondition:function(){function a(a,b){return a&&"date"==b?d.dateStringToPrettyString(a):null===a?"_":a}var b=[];return this.condition.forEach(function(c){if(c.id){var d=" "+c.name+": ";if(c.val instanceof Array){var e=a(c.val[0],c.type),f=a(c.val[1],c.type);d+=[j.between,e,j.and,f].join(" ")}else d+="select"==c.type?this.getSelectConditionLabel(c):c.val;b.push('<span class="usin-combined-filter-preview-item">'+d+"</span>")}}.bind(this)),'<span class="usin-combined-filter-preview-with">'+j["with"]+"</span>"+b.join(' <span class="usin-filter-operator">'+j.and+"</span> ")}}),i.prototype=angular.extend(new e,{setOperators:function(){},formatCondition:function(){return'<span class="usin-combined-filter-preview-error">'+j.error+": "+j.fieldNotExist+"</span>"},previewOperator:function(){return""}}),{create:function(b,d){var j;return d||(d=c.getField(b.by)),j=d&&d.id?-1!==a.optionFieldTypes.indexOf(d.filter.type)?new g:-1!==a.dateFieldTypes.indexOf(d.filter.type)?new f:"combined"==d.filter.type?new h:new e:new i,j.init(b,d),j},createEmpty:function(){return new e}}}]),usinApp.factory("UsinListOptionsQuery",["options","$http","UsinRequestDataPrepare",function(a,b,c){var d=function(c,d){var e=usinHelpers.url.addParam(a.ajaxURL,"action","usin_update_list_opion"),f={option_key:c,option_val:d,nonce:a.nonce};return b({method:"post",url:e,data:f})};return{updateDisplayedFields:function(a){return d("fields",a)},updateFieldOrder:function(a){return d("field_order",a)},updateUsersPerPage:function(a){d("users_per_page",a)},updateProfileSettings:function(a){return d("profile_settings",a)},getExportLink:function(d,e,f){var g={filters:e,nonce:a.nonce,action:"usin_export_link"};return g.fields=angular.toJson(d),f.orderBy&&(g.orderby=f.orderBy),f.order&&(g.order=f.order),e&&e.length&&(g.filters=c.filters(e)),b({method:"get",url:a.ajaxURL,params:g})}}}]),usinApp.factory("UsinListState",function(){var a={};return{isStateSaved:function(b){return a[b]?!0:!1},get:function(b){return a[b]?a[b]:null},set:function(b,c){a[b]=c}}}),usinApp.factory("UsinLoading",function(){var a=!1;return{loading:!1,isLoading:function(){return a},start:function(){a=!0},stop:function(){a=!1}}}),usinApp.factory("UsinMapHelper",["$location","options","UsinMapLayers",function(a,b,c){return{createMap:function(a,b){var d,e,f={};return d={center:this.getCenter(b.center),zoom:b.zoom,maxZoom:12,minZoom:2},e=L.map(a.id,d),c.getTileLayer().addTo(e),b.centerMarker&&L.marker(d.center).addTo(e),b.markers&&(f.mc=this.addMarkers(e,b.markers)),b.disableScrollZoom&&e.scrollWheelZoom.disable(),f.map=e,f},addMarkers:function(a,b){if(b&&b.length){for(var c=L.markerClusterGroup({showCoverageOnHover:!1,maxClusterRadius:50}),d=this.getMarkerObjects(b),e=0,f=d.length;f>e;e++)c.addLayer(d[e]);a.addLayer(c);var g=new L.featureGroup(d);return a.fitBounds(g.getBounds(),{padding:[10,10]}),c}},getMarkerObjects:function(a){var b=[];a=this.differentiateMarkers(a);for(var c=0,d=a.length;d>c;c++){var e=a[c];if(e.coordinates){var f=e.coordinates.split(",").map(parseFloat);f&&2==f.length&&f[0]&&f[1]&&b.push(L.marker(f,{title:e.title}))}}return b},getCenter:function(a){return a&&a.lat&&a.lng?[a.lat,a.lng]:[0,0]},refreshMarkers:function(a,b,c){return markerObjects=this.getMarkerObjects(c),a.removeLayer(b),b=this.addMarkers(a,c)},differentiateMarkers:function(a){for(var b=[],c=function(a){var b=a.split(","),c=b[0],d=b[1],e=.999996,f=1.000001,g=c*(Math.random()*(f-e)+e),h=d*(Math.random()*(f-e)+e);return g+","+h},d=0,e=a.length;e>d;d++){var f=a[d],g=f.coordinates;g&&-1!==b.indexOf(g)&&(a[d].coordinates=c(g)),b.push(a[d].coordinates)}return a}}}]),usinApp.factory("UsinMapLayers",["options",function(a){return{getProtocol:function(){return a.is_ssl?"https":"http"},getTileLayer:function(){var b;return b=a.is_ssl?"https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}@2x.png":"http://{s}.tile.stamen.com/toner/{z}/{x}/{y}@2x.png",L.tileLayer(b,{attribution:'<a href="http://stamen.com">Stamen Design</a>',subdomains:"abcd",maxZoom:20,minZoom:0})}}}]),usinApp.factory("UsinProfileSettingsFactory",["options","UsinFields","$filter","UsinListOptionsQuery",function(a,b,c,d){function e(b,c){var d=m||a.profileSettings,e=d&&d.fields?d.fields:null,f=d&&d.activity?d.activity:null;this.fields=new g(e,b),this.activity=new h(f,c)}function f(a){"undefined"!=typeof a&&(this._config=a,this._setupSettings())}function g(a,b){this._fields=b,f.call(this,a)}function h(a,b){this._userActivity=b,f.call(this,a)}function i(a){a&&(this.id=a.id,this.storeId=this.id,this.config=a)}function j(a){i.call(this,a)}function k(b){b&&(i.call(this,b),this.name=b.name,this.isEditableField=-1!==a.editableFields.indexOf(this.id),this.isStandardField=!this.isEditableField,b.filter&&(this.type=b.filter.type,this.options=b.filter.options))}function l(a){this.id="separator_"+l.counter++,this.storeId=a,this.text=a.replace(l.prefix,""),this.isSeparator=!0}var m=null;return e.prototype=angular.extend(e.prototype,{fields:null,activity:null,save:function(){return m={fields:this.fields.toSettings(),activity:this.activity.toSettings()},d.updateProfileSettings(m)}}),f.prototype=angular.extend(f.prototype,{_config:null,_settings:null,items:null,getItems:function(){if(null!==this.items)return this.items;var a=this._getAllItemIds(),b=a.filter(function(a){return-1===this._settings.order.indexOf(a)}.bind(this)),c=this._settings.order.concat(b);this.items=[];for(var d in c){var e=this._findItem(c[d]);e&&(this._setDefaultHide(e),this.items.push(e))}return this.items},removeItem:function(a){this.items.splice(a,1)},toggleVisibility:function(a){this.items.forEach(function(b){return b.id===a?void(b.hide=!b.hide):void 0})},hiddenCount:function(){return this.items.filter(function(a){return a.hide&&!a.isMissing}).length},toSettings:function(){var a={hide:[],order:[]};return a.hide=this.items.filter(function(a){return a.hide}).map(function(a){return a.storeId}),a.order=this._unique(this.items.map(function(a){return a.storeId})),a},_unique:function(a){return a.filter(function(a,b,c){return c.indexOf(a)===b});
},_setupSettings:function(){this._settings={hide:[],order:[]},this._config&&(this._settings=Object.assign(this._settings,this._config))},_setDefaultHide:function(a){-1!==this._settings.hide.indexOf(a.id)&&(a.hide=!0)},_getAllItemIds:function(){return[]},_findItem:function(a){return null}}),g.prototype=angular.extend(new f,{addSeparator:function(a){this.items.push(l.createByTitle(a))},removeSeparator:function(a){this.items.forEach(function(b,c){b===a&&this.items.splice(c,1)}.bind(this))},_getAllItemIds:function(){return this._fields.map(function(a){return a.id})},_findItem:function(a){if(l.isSeparator(a))return new l(a);var c=b.getField(a);return c?new k(Object.assign({},c)):new j({id:a})}}),h.prototype=angular.extend(new f,{_userActivity:null,_getAllItemIds:function(){return this._userActivity.map(function(a){return a.type})},_findItem:function(a){var b=this._userActivity.filter(function(b){return b.type===a});return b.length?new i({id:a}):new j({id:a})}}),i.prototype=angular.extend(i.prototype,{id:null,storeId:null,hide:!1,config:{},isMissing:!1}),j.prototype=angular.extend(new i,{isMissing:!0}),k.prototype=angular.extend(i.prototype,{name:null,type:"text",options:null,isStandardField:!0,isEditableField:!1,isSeparator:!1}),l.prefix="separator_",l.createByTitle=function(a){var b=l.prefix+a;return new l(b)},l.isSeparator=function(a){return 0===a.indexOf(l.prefix)},l.counter=0,l.prototype=angular.extend(new k,{isStandardField:!1,isEditableField:!1,isSeparator:!0,getStoreId:function(){return this._rawText}}),{init:function(a,b){return new e(a,b)}}}]),usinApp.factory("UsinRequestDataPrepare",function(){return{filters:function(a){var b=a.map(function(a){return a.toHash()});return angular.toJson(b)}}}),usinApp.factory("UsinSegments",["options","$http","UsinRequestDataPrepare",function(a,b,c){return{saveSegment:function(d,e){return b({method:"post",url:usinHelpers.url.addParam(a.ajaxURL,"action","usin_save_segment"),data:{filters:c.filters(e),name:d,nonce:a.nonce,action:"usin_save_segment"}})},deleteSegment:function(c){return b({method:"post",url:usinHelpers.url.addParam(a.ajaxURL,"action","usin_delete_segment"),data:{segment_id:c,nonce:a.nonce}})}}}]),usinApp.factory("UsinSession",["$window",function(a){return{get:function(b){if(!a.sessionStorage)return null;var c=sessionStorage[b];return c&&(c=angular.fromJson(c)),c},set:function(b,c){a.sessionStorage&&(sessionStorage[b]=angular.toJson(c))}}}]),usinApp.factory("UsinUserQuery",["options","$http","$cacheFactory","UsinRequestDataPrepare",function(a,b,c,d){var e=c("lru",{capacity:20});return{getUsers:function(c,f,g,h,i,j){var k=a.ajaxURL,l={action:"usin_get_users",page:c,users_per_page:f,orderby:g,order:h,nonce:a.nonce};return i&&i.length&&(l.filters=d.filters(i)),j&&e.removeAll(),b({method:"get",url:k,params:l,cache:e})},getUser:function(c){var d=a.ajaxURL,f={action:"usin_get_user_data",nonce:a.nonce,userid:c};return b({method:"get",url:d,params:f,cache:e})},getCoordinates:function(c){var f=a.ajaxURL,g={action:"usin_get_coordinates",nonce:a.nonce};return c&&c.length&&(g.filters=d.filters(c)),b({method:"get",url:f,params:g,cache:e})},updateGroups:function(c,d){var e=a.ajaxURL,f={action:"usin_update_groups",nonce:a.nonce,user:c,groups:d};return b({method:"post",url:e,data:f})},updateGroupsBulk:function(c,d,e){var f=a.ajaxURL,g={action:"usin_update_groups_bulk",nonce:a.nonce,users:c,groupId:d,bulkAction:e};return b({method:"post",url:f,data:g})},addNote:function(c,d){var e=a.ajaxURL,f={action:"usin_add_note",nonce:a.nonce,user:c,note:d};return b({method:"post",url:e,data:f})},deleteNote:function(c){var d=a.ajaxURL,e={action:"usin_delete_note",nonce:a.nonce,note_id:c};return b({method:"post",url:d,data:e})},updateUserField:function(c,d,e){var f=a.ajaxURL,g={action:"usin_update_user_field",nonce:a.nonce,user:c,field_id:d,field_value:e};return b({method:"post",url:f,data:g})},getActivityList:function(c,d){var e=a.ajaxURL,f={action:"usin_activity_list_all",type:d,nonce:a.nonce,user:c};return b({method:"get",url:e,params:f})}}}]);
//# sourceMappingURL=user-list.min.js.map